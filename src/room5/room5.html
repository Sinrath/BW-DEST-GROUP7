<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>VR Escape Room - Room 5</title>
    <meta name="description" content="VR Escape Room Room 5 - A-Frame">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <!-- A-Frame Extras (movement controls and collision) -->
    <script src="../../aframe-extras/dist/aframe-extras.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

    <script src="../shared/movement.js"></script>
    <script src="../shared/components.js"></script>
    <script src="room5.js"></script>

</head>
<body>
<!-- 2D overlay (works on PC; becomes DOM Overlay in VR where supported) -->
<div id="ui" style="position:fixed; inset:0; pointer-events:none; z-index:9999; display:block;">
  <div id="ui-panel" style="
      position:fixed; left:20px; bottom:20px; width:340px; pointer-events:auto;
      background:rgba(0,0,0,.85); color:#fff; padding:12px; border-radius:12px; font:14px/1.3 system-ui;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index:10000;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>Room 5 Status</strong>
      <button id="actionBtn" style="padding:4px 8px; background:#007acc; color:white; border:none; border-radius:4px; cursor:pointer;">Action (E)</button>
    </div>
    <div id="status">üèóÔ∏è Room 5: Ready for Development</div>
    <div id="progress">üìã Prototype Planning Phase</div>
    <div style="opacity:.8; font-size:12px;">Q = Drop | E = Action | I = Inventory</div>
  </div>
</div>

<a-scene background="color: #f0f0f0"
         vr-mode-ui="enabled: true"
         webxr="optionalFeatures: dom-overlay, local-floor; overlayElement: #ui">

    <!-- Assets -->
    <a-assets>
        <!-- Add your Room 5 specific assets here -->
    </a-assets>

    <!-- Lighting -->
    <a-light type="ambient" color="#ffffff" intensity="0.9"></a-light>
    <a-light type="directional" position="2 4 2" color="#ffffff" intensity="1.3"></a-light>
    <a-light type="point" position="0 3 0" color="#ffffff" intensity="1.5" distance="20"></a-light>
    <a-light type="point" position="5 2 5" color="#ffffff" intensity="0.8" distance="15"></a-light>
    <a-light type="point" position="-5 2 -5" color="#ffffff" intensity="0.8" distance="15"></a-light>

    <!-- Room 5 Structure (16x16) -->
    <a-box position="0 -0.05 0" width="16" height="0.1" depth="16"
           material="color: #e0e0e0; roughness: 0.3"></a-box>
    <a-box position="0 3.05 0" width="16" height="0.1" depth="16"
           material="color: #f5f5f5; roughness: 0.2"></a-box>

    <!-- Room 5 Walls -->
    <a-box position="0 1.5 -8" width="16" height="3" depth="0.3"
           material="color: #d0d0d0; roughness: 0.4"></a-box>
    <a-box position="-6 1.5 8" width="4" height="3" depth="0.3"
           material="color: #d0d0d0; roughness: 0.4"></a-box>
    <a-box position="6 1.5 8" width="4" height="3" depth="0.3"
           material="color: #d0d0d0; roughness: 0.4"></a-box>
    <a-box position="-8 1.5 0" width="0.3" height="3" depth="16"
           material="color: #d0d0d0; roughness: 0.4"></a-box>
    <a-box position="8 1.5 0" width="0.3" height="3" depth="16"
           material="color: #d0d0d0; roughness: 0.4"></a-box>

    <!-- Door back to Room 4 -->
    <a-box id="door-room4" position="-2 1.5 8" width="1.5" height="2.5" depth="0.3"
           material="color: #4A4A4A; roughness: 0.3"
           class="door" data-target="../room4/room4.html"></a-box>
    <a-text position="-2 2.8 7.8" rotation="0 180 0" value="‚Üê ROOM 4" align="center"
            color="red" scale="0.8 0.8 0.8"></a-text>
    <a-text position="-2 2.3 7.8" rotation="0 180 0" value="(Back)" align="center"
            color="white" scale="0.4 0.4 0.4"></a-text>

    <!-- Exit Door (Future: could lead to final area or back to entrance) -->
    <a-box id="door-exit" position="2 1.5 8" width="1.5" height="2.5" depth="0.3"
           material="color: #FFD700; roughness: 0.3"
           class="door" data-target="../entrance.html"></a-box>
    <a-text position="2 2.8 7.8" rotation="0 180 0" value="EXIT ‚Üí" align="center"
            color="red" scale="0.9 0.9 0.9"></a-text>
    <a-text position="2 2.3 7.8" rotation="0 180 0" value="(Complete!)" align="center"
            color="white" scale="0.4 0.4 0.4"></a-text>

    <!-- Room Title -->
    <a-text position="0 2.5 -7" value="ROOM 5 - PROTOTYPE SPACE" align="center"
            color="black" scale="1.2 1.2 1.2"></a-text>

    <!-- Placeholder Content for Room 5 Development -->
    <a-box position="0 1 0" width="2" height="2" depth="2"
           material="color: #4CAF50; roughness: 0.3"
           class="placeholder interactive"
           data-info="Room 5 Prototype Area - Ready for your next innovative puzzle concept!"></a-box>
    <a-text position="0 2.2 0" value="ROOM 5\nPROTOTYPE" align="center"
            color="white" scale="0.8 0.8 0.8"></a-text>

    <!-- Development Notes (visible placeholder) -->
    <a-plane position="-5 2 -3" width="3" height="2" material="color: #2196F3; opacity: 0.8">
        <a-text position="0 0.5 0.01" value="ROOM 5 DEVELOPMENT" align="center"
                color="white" scale="0.6 0.6 0.6"></a-text>
        <a-text position="0 0 0.01" value="‚Ä¢ New puzzle mechanics\n‚Ä¢ Advanced interactions\n‚Ä¢ Enhanced UI features" align="center"
                color="white" scale="0.4 0.4 0.4"></a-text>
        <a-text position="0 -0.5 0.01" value="Ready for innovation!" align="center"
                color="yellow" scale="0.5 0.5 0.5"></a-text>
    </a-plane>

    <a-entity id="leftHand"
              hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
    <a-entity id="rightHand"
              hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"></a-entity>

    <a-entity id="rig"
              position="0 1.6 5"
              movement-controls="controls: keyboard, touch"
              simple-collision>
        <a-entity id="playerCam" camera look-controls>
            <a-cursor position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat"
                      raycaster="objects: .door, .interactive; showLine: true"></a-cursor>

        <!-- World-space HUD fallback (hidden unless DOM Overlay is unavailable) -->
        <a-entity id="world-hud" position="-1.2 -0.8 -1.8" visible="false">
            <a-plane width="2.2" height="0.8" material="color: #333333; opacity: 0.85" position="0 0 0">
                <a-text value="ROOM 5 STATUS" position="0 0.2 0.01" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
                <a-text id="world-status" value="üèóÔ∏è Ready for Development" position="0 0 0.01" align="center" color="lime" scale="0.35 0.35 0.35"></a-text>
                <a-text id="world-progress" value="üìã Prototype Planning" position="0 -0.15 0.01" align="center" color="cyan" scale="0.35 0.35 0.35"></a-text>
                <a-text value="Q = Drop | E = Action" position="0 -0.3 0.01" align="center" color="yellow" scale="0.28 0.28 0.28"></a-text>
            </a-plane>
        </a-entity>

        <!-- VR Inventory instruction (only visible in VR without DOM Overlay) -->
        <a-text id="vr-inventory-hint" position="-2 -1.2 -1.8"
                value="Press I for Interface" align="center"
                color="#666666" scale="0.3 0.3 0.3" visible="false"></a-text>
        </a-entity>

    <!-- UI Text -->
    <a-text id="message" position="0 2.8 2"
            value="Welcome to Room 5 - Prototype Development Space!\nThis room is ready for your next innovative puzzle concept."
            align="center" color="black" scale="0.5 0.5 0.5" look-at="#playerCam"></a-text>
</a-scene>

<script>
(function () {
    const overlay = document.getElementById('ui');
    const scene = document.querySelector('a-scene');
    let isInVRWithoutDOMOverlay = false;
    let vrHudVisible = false;

    function showOverlay2D() {
        if (overlay) {
            overlay.style.display = 'block';
            console.log('2D overlay shown');
        }
    }
    function hideOverlay2D() {
        if (overlay) {
            overlay.style.display = 'none';
            console.log('2D overlay hidden');
        }
    }
    function showWorldHud(v) {
        const worldHud = document.getElementById('world-hud');
        if (worldHud) {
            worldHud.setAttribute('visible', !!v);
            console.log('World HUD:', !!v ? 'shown' : 'hidden');
        }
    }
    function toggleVRInventory() {
        if (isInVRWithoutDOMOverlay) {
            vrHudVisible = !vrHudVisible;
            showWorldHud(vrHudVisible);
            console.log('VR interface toggled:', vrHudVisible);
        }
    }
    function showVRHint(show) {
        const hint = document.getElementById('vr-inventory-hint');
        if (hint) {
            hint.setAttribute('visible', show);
        }
    }

    // Initialize immediately for desktop
    console.log('Initializing Room 5 UI...');
    showOverlay2D();

    // Also set up when scene loads
    if (scene) {
        scene.addEventListener('loaded', () => {
            console.log('Scene loaded, ensuring 2D overlay is visible');
            showOverlay2D();
            showWorldHud(false);
        });

        // Entering VR: choose DOM Overlay if available, otherwise world HUD
        scene.addEventListener('enter-vr', () => {
            console.log('Entering VR mode');
            const session = scene.renderer?.xr?.getSession?.();
            const domOverlayActive = !!(session && session.domOverlayState);
            console.log('DOM Overlay active:', domOverlayActive);

            if (domOverlayActive) {
                // Keep the 2D overlay (now rendered *inside* XR as a DOM Overlay)
                showOverlay2D();
                showWorldHud(false);
                showVRHint(false);
                isInVRWithoutDOMOverlay = false;
            } else {
                // DOM Overlay not supported ‚Üí use toggleable world-space HUD
                hideOverlay2D();
                showWorldHud(false); // Start hidden, toggle with I key
                showVRHint(true);    // Show "Press I for Interface" hint
                isInVRWithoutDOMOverlay = true;
                vrHudVisible = false;
            }
        });

        // Back to flat screen
        scene.addEventListener('exit-vr', () => {
            console.log('Exiting VR mode');
            showOverlay2D();
            showWorldHud(false);
            showVRHint(false);
            isInVRWithoutDOMOverlay = false;
        });
    }

    // Wire desktop button to game logic
    document.getElementById('actionBtn')?.addEventListener('click', () => {
        console.log('Action button clicked');
        // Trigger same action function as 'E' key
        document.dispatchEvent(new KeyboardEvent('keydown', {key: 'e'}));
    });

    // Add global keyboard listener for I key (VR interface toggle)
    document.addEventListener('keydown', (event) => {
        if (event.key === 'i' || event.key === 'I') {
            toggleVRInventory();
        }
    });
})();
</script>
</body>
</html>